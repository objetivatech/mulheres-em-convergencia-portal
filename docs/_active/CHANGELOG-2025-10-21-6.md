# Changelog - 21/10/2025 (Parte 6)

## Melhorias no Fluxo de Cortesia e Integração com Asaas

### 1. Ao Ativar Cortesia

**Problema**: Ao ativar cortesia, o sistema não cancelava assinaturas com status "pending" nem suas cobranças no Asaas.

**Solução**:
- **Cancelamento Abrangente**: Agora, ao ativar cortesia, o sistema cancela assinaturas com status "active" **e** "pending".
- **Cancelamento de Cobranças**: Criada a edge function `cancel-asaas-payment` para cancelar cobranças pendentes no Asaas.
- **Atualização de Status**: O status da assinatura é atualizado para "cancelled" no banco de dados.

**Arquivos modificados**:
- `src/components/admin/ComplimentaryBusinessManager.tsx`
- `supabase/functions/cancel-asaas-payment/index.ts` (novo)

### 2. Ao Desativar Cortesia

**Problema**: Ao desativar cortesia, o usuário ficava sem plano e nenhuma ação era tomada.

**Solução**:
- **Criação Automática de Plano**: Agora, ao desativar cortesia, o sistema cria automaticamente uma assinatura do plano "Básico Mensal".
- **Integração com Asaas**: A criação da assinatura gera uma nova cobrança e recorrência no Asaas.
- **Aguardar Pagamento**: A assinatura é criada com status "pending" e só é ativada após o pagamento.

**Arquivos modificados**:
- `src/components/admin/ComplimentaryBusinessManager.tsx`

---

**Data**: 21 de outubro de 2025  
**Responsável**: Manus AI
