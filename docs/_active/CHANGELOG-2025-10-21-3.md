# Changelog - 21/10/2025 (Parte 3)

## Correção de Permissões do Editor de Blog

### Problema Identificado

O editor de blog (TinyMCE) estava funcionando apenas para um usuário administrador específico (`diogodevitte@outlook.com`), mas não para outros administradores ou usuários com a role "Editor de Blog".

### Causa Raiz

O sistema de autenticação verifica as permissões através da função `get_current_user_blog_edit_status()`, que consulta a tabela `user_roles` para verificar se o usuário tem a role `admin` ou `blog_editor`.

Embora existisse uma migração anterior que deveria sincronizar os campos `is_admin` e `can_edit_blog` da tabela `profiles` com a tabela `user_roles`, essa sincronização pode não ter sido executada para todos os usuários ou pode ter havido novos administradores adicionados posteriormente sem a role correspondente.

### Solução Implementada

Foi criada uma nova migração SQL (`20251021175657_sync_admin_blog_roles.sql`) que:

1. **Re-sincroniza Imediatamente**: Executa novamente a inserção de roles para todos os usuários que têm `is_admin = true` ou `can_edit_blog = true` na tabela `profiles`, garantindo que todos tenham as roles corretas em `user_roles`.

2. **Trigger Automático**: Cria uma função `sync_profile_roles()` e um trigger `sync_profile_roles_trigger` que mantém a sincronização automática entre as duas tabelas sempre que os campos `is_admin` ou `can_edit_blog` forem alterados.

3. **Sincronização Bidirecional**: O trigger garante que:
   - Quando `is_admin` é ativado → role `admin` é adicionada
   - Quando `is_admin` é desativado → role `admin` é removida
   - Quando `can_edit_blog` é ativado → role `blog_editor` é adicionada
   - Quando `can_edit_blog` é desativado → role `blog_editor` é removida

### Arquivos Modificados

- `supabase/migrations/20251021175657_sync_admin_blog_roles.sql` (novo arquivo)

### Próximos Passos

Após o deploy desta migração no Supabase, todos os usuários administradores e editores de blog terão acesso correto ao editor TinyMCE, independentemente de quando foram adicionados ao sistema.

### Verificação

Para verificar se um usuário tem as permissões corretas, você pode executar no SQL Editor do Supabase:

```sql
SELECT 
  p.email,
  p.is_admin,
  p.can_edit_blog,
  ARRAY_AGG(ur.role) as roles
FROM profiles p
LEFT JOIN user_roles ur ON ur.user_id = p.id
WHERE p.email = 'email@exemplo.com'
GROUP BY p.id, p.email, p.is_admin, p.can_edit_blog;
```

---

**Data**: 21 de outubro de 2025  
**Responsável**: Manus AI

